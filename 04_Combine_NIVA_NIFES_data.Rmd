---
title: "Combine NIVA and NIFES data"
output: html_document
---


## Packages + functions  
```{r}
library(dplyr)
library(tidyr)
library(readxl)
library(ggplot2)

```

## Data
Indicators from NIVA serves as the starting point for combining the data  
```{r}
# NIVA medians
data_xl_sel <- readRDS("Data/03_data_xl_sel.rds")

# NIVA indicators
df_indicator <- readRDS("Data/03_df_indicator_NIVA_only.rds") %>%
  filter(!STATION_CODE %in% "19B")                                     # exclude 19B (Svalbard)

# NIFES medians
df_median <- readRDS("Data/01_df_median.rds") %>%
  as.data.frame()

# NIFES regression
nifes_regression <- readRDS("Data/02_nifes_regression.rds")

# Food and EQS limits
df_limits <- read_excel("Input_data/Grenseverdier_fra_Sylvia.xlsx")

# Parameters
sel_param <- c("CD", "HG", "PB", "BDE6S", "HCB", "DDEPP", "CB_S7")
```



## Make 'df_nifes_finalyear'   
```{r}
df_median <- df_median %>%
  mutate(TISSUE_NAME =
           case_when(Organ %in% "Filet" ~ "Muskel",
                     Organ %in% "Lever" ~ "Lever")
  )

df_median <- df_median %>%
  mutate(STATION_NAME = 
           case_when(Uttaksområde %in% "Møre" ~ "Møre",
                     Uttaksområde %in% c("Træna","Vikna") ~ "Helgeland",
                     Uttaksområde %in% "Vestfjorden" ~ "Lofoten"),
         NIVA_CODE = 
           case_when(TISSUE_NAME %in% "Muskel" ~ "MU",
                     TISSUE_NAME %in% "Lever" ~ "LI")
  )

sel <- df_median$Uttaksområde %in% "Møre"; sum(sel)
df_median$STATION_NAME[sel] <- "Møre"


# Get last year's median
df_nifes_finalyear <- df_median %>% 
  filter(Parameter %in% sel_param & !is.na(Conc)) %>%
  group_by(STATION_NAME, Parameter, TISSUE_NAME, NIVA_CODE)  %>%
  mutate(Maxyear = max(Year)) %>%
  filter(Year == Maxyear) %>%
  select(-LONGITUDE, -LATITUDE) %>%
  as.data.frame()

df_nifes_pos <- df_median %>% 
  filter(Parameter %in% sel_param & !is.na(Conc)) %>%
  group_by(STATION_NAME)  %>%
  summarize(
    LONGITUDE = median(LONGITUDE, na.rm = TRUE),
    LATITUDE = median(LATITUDE, na.rm = TRUE)
  )

df_nifes_finalyear <- 
  df_nifes_finalyear %>% left_join(df_nifes_pos)

xtabs(~Parameter + TISSUE_NAME, df_nifes_finalyear)  

```


## Make 'df_indicator_nifes'
```{r}
df_indicator_nifes <- tibble(
       PROJECT_ID = 9999,
       LATIN_NAME = "Gadus morhua",
       STATION_CODE = "9999", 
       STATION_NAME = df_nifes_finalyear$STATION_NAME,
       LONGITUDE = df_nifes_finalyear$LONGITUDE, 
       LATITUDE = df_nifes_finalyear$LATITUDE,
       PARAM = df_nifes_finalyear$Parameter,
       N = df_nifes_finalyear$N,
       Conc = df_nifes_finalyear$Conc,
       SPECIES_ID = 17,
       TISSUE_NAME = df_nifes_finalyear$TISSUE_NAME,
       NIVA_CODE = df_nifes_finalyear$NIVA_CODE
       )

# Add TISSUE_NAME to nifes_regression (for join below)
nifes_regression <- nifes_regression %>%
  mutate(TISSUE_NAME =
           case_when(Tissue %in% "Filet" ~ "Muskel",
                     Tissue %in% "Lever" ~ "Lever")
  )

# xtabs(~STATION_NAME, nifes_regression)
nrow(df_indicator_nifes)
df_indicator_nifes <- left_join(df_indicator_nifes, nifes_regression[,c("PARAM", "TISSUE_NAME", "STATION_NAME", "trend")])
nrow(df_indicator_nifes)

# Check
# df_indicator_nifes %>% select(STATION_NAME, LATITUDE, Conc, NIVA_CODE, trend) %>% View()
# df_indicator %>% select(STATION_NAME, LATITUDE, Conc, NIVA_CODE, trend) %>% View()

```

## Combine NIVA and NIFES data
```{r}

df_indicator2 <- bind_rows(df_indicator, df_indicator_nifes)
df_indicator2 %>% head(2)
nrow(df_indicator2)  # 111

# Check liver
# xtabs(~STATION_NAME + PARAM, df_indicator2 %>% filter(TISSUE_NAME == "Lever"))  # 94

```

## Map data
```{r}
# Check that all stations have positions
sum(is.na(df_indicator2$LATITUDE))

df_indicator2 %>%
  count(STATION_NAME, LATITUDE,  LONGITUDE) %>%
  arrange(LATITUDE)

plot(LATITUDE ~ LONGITUDE, df_indicator2)
maps::map(regions = "Norway", add = TRUE, col = "brown")
```

## Filter df_indicator2 by position
```{r}

df_indicator2 <- df_indicator2 %>% 
  filter(LATITUDE > 62 & LONGITUDE < 22.2)

tab <- df_indicator2 %>%
  count(STATION_NAME, LATITUDE,  LONGITUDE) %>%
  arrange(LATITUDE) 

# Make STATION_NAME a factor with order = latitude
df_indicator2 <- df_indicator2 %>% 
  mutate(STATION_NAME = factor(STATION_NAME, levels = tab$STATION_NAME))

tab 


```

## Proref, EQS and mattrygghet
```{r}
# Get PROREF (Q95) and EQS
df_q95 <- data_xl_sel[data_xl_sel$Basis %in% "WW", c("PARAM", "LATIN_NAME", "TISSUE_NAME", "Q95", "EQS")] %>%
  group_by(PARAM, LATIN_NAME, TISSUE_NAME) %>%
  summarise(Q95 = first(Q95), EQS_threshold = first(EQS))

# Check
# df_q95 %>% filter(PARAM == "HG")

# add PROREF and EQS thresholds
nrow(df_indicator2) # 94
df_indicator2 <- left_join(df_indicator2, df_q95)
nrow(df_indicator2) # 94

# change EQS threshold for Hg (by mail from Norman; from 1.00 to 0.67)
sel <- df_indicator2$PARAM %in% "CB_S7"; sum(sel) 
df_indicator2$EQS_threshold[sel] <- 0.67

# Classes changed - original classes were: c(-999999,1,2,5,10,20,999999)
df_indicator2$KLASSE <- with(df_indicator2, 
                             cut(Conc/Q95, breaks = c(-999999,1,2,10,999999), 
                                 right = FALSE, labels = FALSE)
                             )

xtabs(~KLASSE + PARAM, df_indicator2)
#       PARAM
# KLASSE CB_S7 CD DDEPP HCB HG
#      1    14 14     5   7  4
#      2     0  1     1   0  3
#      3     2  1     1   0 10

# EQS classe
df_indicator2$EQS <- with(df_indicator2, 
                          cut(Conc/EQS_threshold, breaks = c(-999999,1,999999), 
                              right = FALSE, labels = FALSE)
                          )

xtabs(~addNA(EQS) + PARAM, df_indicator2)
#            PARAM
# addNA(EQS) BDE6S CB_S7 CD DDEPP HCB HG PB
#       1        0     0  0     7   7  0  0
#       2       11    16  0     0   0 17  0
#       <NA>     0     0 17     1   1  0 17



```

## Add SPECIES_ID
```{r}

species_code <- 17
df_indicator2$SPECIES_ID <- species_code

```

## Add food limit  
1 = below limit, 2 = above limit
```{r}

nrow(df_indicator2)
df_indicator2 <- left_join(
  df_indicator2, 
  subset(df_limits, select = c(PARAM, LATIN_NAME, NIVA_CODE, Mattrygghet)), 
  by = c("PARAM", "LATIN_NAME", "NIVA_CODE"))
nrow(df_indicator2)
# 96

df_indicator2$Mattrygghet <- cut(with(df_indicator2, Conc/Mattrygghet),
                                 breaks = c(-999999,1,999999), 
                                 right = FALSE, labels = FALSE)

xtabs(~addNA(Mattrygghet) + PARAM + TISSUE_NAME, df_indicator2)

# tail(df_indicator2)

```

## Save and export  
* On 'data': save with all variables   
* On 'Data_export': pick selected variables  
```{r}
# Save with all variables
saveRDS(df_indicator2, file = "Data/04_df_indicator2_cod_ver1.RData")

# Save with selected variables
vars <- c("PROJECT_ID", "STATION_CODE", "STATION_NAME", 
  "LONGITUDE", "LATITUDE", "PARAM", "N", "KLASSE", 
  "SPECIES_ID", "trend", "NIVA_CODE", "EQS", "Mattrygghet")

# DOnt include HG in liver
sel <- with(df_indicator2, !(PARAM == "HG" & TISSUE_NAME == "Lever"))

# setwd("H:/Documents/seksjon 212/Indikator 2018/Analyse")
write.csv2(df_indicator2[sel,vars], file = "Data_export/GaduMor_2018_withNIFES_ver2.csv", row.names = FALSE, na = "")

# df_indicator2 <- read.csv2(file = "Data_export/GaduMor_2018_withNIFES_ver1.csv")

```

## Checks
### Plot 1
trend: 0 = no trend calculated, 1 = zero time trend, 2 = up, 3 = down  
```{r}
df <- df_indicator2 %>%
  mutate(Time_trend =
           case_when(trend %in% 0 ~ "Not calc.",
                     trend %in% 1 ~ "No trend",
                     trend %in% 2 ~ "Down",
                     trend %in% 3 ~ "Up")
         ) %>%
  mutate(Time_trend = factor(Time_trend, levels = c("Not calc.", "No trend", "Down", "Up")))

df %>%
  filter(PARAM %in% unique(PARAM)[1:3]) %>%
  ggplot(aes(STATION_NAME, Conc, fill = factor(Time_trend))) + 
  geom_col() + 
  scale_fill_manual(values = c("grey30", "orange", "green", "red")) +
  facet_wrap(~paste(PARAM,TISSUE_NAME), scales = "free", nrow = 1) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2))
```

### Plot 2
```{r}
df %>%
  filter(PARAM %in% unique(PARAM)[4:7]) %>%
  ggplot(aes(STATION_NAME, Conc, fill = Time_trend)) + 
  geom_bar(stat = "identity") + 
  scale_fill_manual(values = c("grey30", "orange", "green", "red")) +
  facet_wrap(~paste(PARAM,TISSUE_NAME), scales = "free", nrow = 1) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2))
```

