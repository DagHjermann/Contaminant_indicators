---
title: "Combine NIVA and NIFES data"
output: html_document
---


## Packages + functions  
```{r}
library(dplyr)
library(tidyr)
library(readxl)
library(ggplot2)

```

## Data
Indicators from NIVA serves as the starting point for combining the data  
```{r}
df_indicator <- readRDS("Data/03_df_indicator_NIVA_only.rds") %>%
  filter(!STATION_CODE %in% "19B")                                     # exclude 19B (Svalbard)

# NIFES medians
df_median <- readRDS("Data/01_df_median.rds") %>%
  as.data.frame()

# NIFES regression
nifes_regression <- read.csv("Data/02_nifes_regression.csv", stringsAsFactors = FALSE)

sel_param <- c("CD", "HG", "PB", "BDE6S", "HCB", "DDEPP", "CB_S7")
```

## Make 'df_nifes_lastyear'   
```{r}
df_median <- df_median %>%
  mutate(TISSUE_NAME =
           case_when(Organ %in% "Filet" ~ "Muskel",
                     Organ %in% "Lever" ~ "Lever")
  )

df_median <- df_median %>%
  mutate(STATION_NAME = 
           case_when(Uttaksområde %in% "Møre" ~ "Møre",
                     Uttaksområde %in% c("Træna","Vikna") ~ "Helgeland",
                     Uttaksområde %in% "Vestfjorden" ~ "Lofoten"),
         NIVA_CODE = 
           case_when(TISSUE_NAME %in% "Muskel" ~ "MU",
                     TISSUE_NAME %in% "Lever" ~ "LI")
  )

sel <- df_median$Uttaksområde %in% "Møre"; sum(sel)
df_median$STATION_NAME[sel] <- "Møre"


# Get last year's median
df_nifes_lastyear <- df_median %>% 
  filter(Parameter %in% sel_param & !is.na(Conc)) %>%
  group_by(STATION_NAME, Parameter, TISSUE_NAME, NIVA_CODE)  %>%
  mutate(Maxyear = max(Year)) %>%
  filter(Year == Maxyear) %>%
  select(-LONGITUDE, -LATITUDE) %>%
  as.data.frame()

df_nifes_pos <- df_median %>% 
  filter(Parameter %in% sel_param & !is.na(Conc)) %>%
  group_by(STATION_NAME)  %>%
  summarize(
    LONGITUDE = median(LONGITUDE, na.rm = TRUE),
    LATITUDE = median(LATITUDE, na.rm = TRUE)
  )

df_nifes_lastyear <- 
  df_nifes_lastyear %>% left_join(df_nifes_pos)
  
```


## Make 'df_indicator_nifes'
```{r}
df_indicator_nifes <- tibble(
       PROJECT_ID = 9999,
       LATIN_NAME = "Gadus morhua",
       STATION_CODE = "9999", 
       STATION_NAME = df_nifes_lastyear$STATION_NAME,
       LONGITUDE = df_nifes_lastyear$LONGITUDE, 
       LATITUDE = df_nifes_lastyear$LATITUDE,
       PARAM = df_nifes_lastyear$Parameter,
       N = df_nifes_lastyear$N,
       Conc = df_nifes_lastyear$Conc,
       SPECIES_ID = 17,
       TISSUE_NAME = df_nifes_lastyear$TISSUE_NAME,
       NIVA_CODE = df_nifes_lastyear$NIVA_CODE
       )

# xtabs(~STATION_NAME, nifes_regression)
nrow(df_indicator_nifes)
df_indicator_nifes <- left_join(df_indicator_nifes, nifes_regression[,c("PARAM", "STATION_NAME", "trend")])
nrow(df_indicator_nifes)

# Check
# df_indicator_nifes %>% select(STATION_NAME, LATITUDE, Conc, NIVA_CODE, trend) %>% View()
# df_indicator %>% select(STATION_NAME, LATITUDE, Conc, NIVA_CODE, trend) %>% View()

```

## Combine NIVA and NIFES data
```{r}

df_indicator2 <- bind_rows(df_indicator, df_indicator_nifes)
df_indicator2 %>% head(2)
nrow(df_indicator2)  # 94

# Check liver
# xtabs(~STATION_NAME + PARAM, df_indicator2 %>% filter(TISSUE_NAME == "Lever"))  # 94

```

## Map data
```{r}
# Check that all stations have positions
sum(is.na(df_indicator2$LATITUDE))

df_indicator2 %>%
  count(STATION_NAME, LATITUDE,  LONGITUDE) %>%
  arrange(LATITUDE)

plot(LATITUDE ~ LONGITUDE, df_indicator2)
maps::map(regions = "Norway", add = TRUE, col = "brown")
```

## Filter df_indicator2 by position
```{r}

df_indicator2 <- df_indicator2 %>% 
  filter(LATITUDE > 62 & LONGITUDE < 22.2)

tab <- df_indicator2 %>%
  count(STATION_NAME, LATITUDE,  LONGITUDE) %>%
  arrange(LATITUDE) 

# Make STATION_NAME a factor with order = latitude
df_indicator2 <- df_indicator2 %>% 
  mutate(STATION_NAME = factor(STATION_NAME, levels = tab$STATION_NAME))

tab 


```

## Proref, EQS and mattrygghet
```{r}
# Get PROREF (Q95) and EQS
df_q95 <- data_xl[data_xl$Basis %in% "WW", c("PARAM", "LATIN_NAME", "TISSUE_NAME", "Q95", "EQS")] %>%
  group_by(PARAM, LATIN_NAME, TISSUE_NAME) %>%
  summarise(Q95 = first(Q95), EQS_threshold = first(EQS))

# Check
# df_q95 %>% filter(PARAM == "HG")

# add PROREF and EQS thresholds
nrow(df_indicator2) # 94
df_indicator2 <- left_join(df_indicator2, df_q95)
nrow(df_indicator2) # 94

# change EQS threshold for Hg (by mail from Norman; from 1.00 to 0.67)
sel <- df_indicator2$PARAM %in% "CB_S7"; sum(sel) 
df_indicator2$EQS_threshold[sel] <- 0.67

# Classes changed - original classes were: c(-999999,1,2,5,10,20,999999)
df_indicator2$KLASSE <- with(df_indicator2, 
                             cut(Conc/Q95, breaks = c(-999999,1,2,10,999999), 
                                 right = FALSE, labels = FALSE)
                             )

xtabs(~KLASSE + PARAM, df_indicator2)
#       PARAM
# KLASSE CB_S7 CD DDEPP HCB HG
#      1    14 14     5   7  4
#      2     0  1     1   0  3
#      3     2  1     1   0 10

# EQS classe
df_indicator2$EQS <- with(df_indicator2, 
                          cut(Conc/EQS_threshold, breaks = c(-999999,1,999999), 
                              right = FALSE, labels = FALSE)
                          )

xtabs(~addNA(EQS) + PARAM, df_indicator2)
#            PARAM
# addNA(EQS) BDE6S CB_S7 CD DDEPP HCB HG PB
#       1        0     0  0     7   7  0  0
#       2       11    16  0     0   0 17  0
#       <NA>     0     0 17     1   1  0 17



```

## Add SPECIES_ID
```{r}
df_indicator2$SPECIES_ID <- species_code

```

## Add food limit
```{r}


nrow(df_indicator2)
df_indicator2 <- left_join(
  df_indicator2, 
  subset(df_limits, select = c(PARAM, LATIN_NAME, NIVA_CODE, Mattrygghet)), 
  by = c("PARAM", "LATIN_NAME", "NIVA_CODE"))
nrow(df_indicator2)
# 96

df_indicator2$Mattrygghet <- cut(with(df_indicator2, Conc/Mattrygghet),
                                 breaks = c(-999999,1,999999), 
                                 right = FALSE, labels = FALSE)

xtabs(~addNA(Mattrygghet) + PARAM, df_indicator2)

# tail(df_indicator2)

```

## Save and export
```{r}
saveRDS(df_indicator2, file = "Data/04_df_indicator2_cod_ver1.RData")

vars <- c("PROJECT_ID", "STATION_CODE", "STATION_NAME", 
  "LONGITUDE", "LATITUDE", "PARAM", "N", "KLASSE", 
  "SPECIES_ID", "trend", "NIVA_CODE", "EQS", "Mattrygghet")

# setwd("H:/Documents/seksjon 212/Indikator 2018/Analyse")
write.csv2(df_indicator2[,vars], file = "Data_export/GaduMor_2018_withNIFES_ver1.csv", row.names = FALSE, na = "")

# df_indicator2 <- read.csv2(file = "Data_export/GaduMor_2018_withNIFES_ver1.csv")

```


## Checks
### Plot 1
trend: 0 = no trend calculated, 1 = zero time trend, 2 = up, 3 = down  
```{r}
df <- df_indicator2 %>%
  filter(PARAM %in% unique(PARAM)[1:3]) %>%
  mutate(Time_trend =
           case_when(trend %in% 0 ~ "Not calc.",
                     trend %in% 1 ~ "No trend",
                     trend %in% 2 ~ "Down",
                     trend %in% 3 ~ "Up")
         ) %>%
  mutate(Time_trend = factor(Time_trend, levels = c("Not calc.", "No trend", "Down", "Up")))

ggplot(df, aes(STATION_NAME, Conc, fill = factor(Time_trend))) + 
  geom_col() + 
  scale_fill_manual(values = c("grey30", "orange", "green", "red")) +
  facet_wrap(~PARAM, scales = "free") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2))
```

### Plot 2
```{r}
df_indicator2 %>%
  filter(PARAM %in% unique(PARAM)[4:7]) %>%
  ggplot(aes(STATION_NAME, Conc, fill = factor(trend))) + 
  geom_bar(stat = "identity") + 
  facet_wrap(~PARAM, scales = "free", nrow = 1) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2))
```

```{r}
df_indicator2 %>% 
  filter(PARAM == "CD") %>% 
  arrange(LATITUDE) %>% select(STATION_NAME, LATITUDE, Conc, NIVA_CODE, trend)

```


```{r}
# Adding trend
# Based on "18_Time_series_write_to_Excel_functions.R"
df_symbol_to_trend <- tibble(
  trend_symbol = c("§", "«", "¢", "é", "ê"),
  trend_text = c("Too little data", "Too few data above LOQ", "No trend", "Trend up", "Trend down"),
  trend = c(0,0,1,2,3)
  )
```

```{r}

```

# Table for adding trend (same as above)
nifes_regression <- left_join(nifes_regression, df_symbol_to_trend[,c("trend_text", "trend")])

# Change name (for later combining with NIVA data)
nifes_regression <- rename(nifes_regression, PARAM = Parameter)




```{r}

# Change organ names
df_median <- rename(df_median, TISSUE_NAME = Organ)
sel <- df_median$TISSUE_NAME %in% "Filet"; sum(sel)    # 126
df_median$TISSUE_NAME[sel] <- "Muskel"

# Add NIVA_CODE
df_median <- left_join(df_median, df_tissue_code, by = "TISSUE_NAME")

#
# Pick year
# We pick the most recent year with data (2014 for HCB and DDEPP, otherwise 2016)
#
xtabs(~Parameter + Year, df_median %>% filter(Parameter %in% sel_param & !is.na(Conc)))
#          Year
# Parameter 2009 2010 2011 2014 2015 2016 2017
#     BDE6S    1    1    1    1    2    1    1
#     CB_S7    1    1    1    1    2    1    0
#     CD       1    1    1    1    1    1    1
#     DDEPP    0    1    0    1    0    0    0
#     HCB      0    1    0    1    0    0    0
#     HG       1    1    1    1    1    1    1
#     PB       1    1    1    1    1    1    1
 
sel_nordsjo_1 <- df_median$Parameter %in% c("HCB", "DDEPP") & df_median$Year %in% 2014
sel_nordsjo_2 <- df_median$Parameter %in% c("CD", "HG", "PB", "BDE6S", "CB_S7") & df_median$Year %in% 2016
sel_nordsjo <- sel_nordsjo_1 | sel_nordsjo_2
sum(sel_nordsjo)

df_nordsjo <- tibble(
       PROJECT_ID = 9999,
       LATIN_NAME = "Gadus morhua",
       STATION_CODE = 9999, 
       STATION_NAME = "Nordsjøen",
       LONGITUDE = 3, 
       LATITUDE = 59,
       PARAM = df_median$Parameter[sel_nordsjo],
       N = df_median$N[sel_nordsjo],
       Conc = df_median$Conc[sel_nordsjo],
       SPECIES_ID = 17,
       TISSUE_NAME = df_median$TISSUE_NAME[sel_nordsjo],
       NIVA_CODE = df_median$NIVA_CODE[sel_nordsjo]
       )

df_nordsjo <- left_join(df_nordsjo, nifes_regression[,c("PARAM", "trend")])
df_nordsjo

xtabs(~PARAM + TISSUE_NAME, df_nordsjo)
```


```{r}
# Station names + coordinates
folder_milkys <- "H:/Documents/seksjon 212/Milkys 2017/Analyse"
df_stations <- read_excel(paste0(folder_milkys, '/Stasjonsfiler/Milkys_koordinater_Sammenligning_NOG_0410_2017_forR.xlsx'), sheet = "for_R")
colnames(df_stations)[1:3] <- c("LATITUDE", "LONGITUDE", "STATION_CODENAME")
df_stations$STATION_CODE <- stringr::str_extract(df_stations$STATION_CODENAME, "([^[[:blank:]]]+)") 
df_stations$STATION_NAME <- stringr::str_extract(df_stations$STATION_CODENAME, "(?<=[[:blank:]]).*")
df_stations <- df_stations[,c("STATION_CODE", "STATION_NAME", "LONGITUDE", "LATITUDE")]
head(df_stations)

```

### 
```{r}

species <- "Gadus morhua"
species_code <- 17
# Muscle data (Hg)
tissue <- "Muskel"
sel_param <- c("HG")
sel_records1 <- with(data_xl, PARAM %in% sel_param & TISSUE_NAME %in% tissue & LATIN_NAME %in% species & Basis == "WW" & !is.na(Klasse.2016))
# Liver data (the rest)
tissue <- "Lever"
sel_param <- c("CD", "HG", "PB", "BDE6S", "HCB", "DDEPP", "CB_S7")
sel_records2 <- with(data_xl, PARAM %in% sel_param & TISSUE_NAME %in% tissue & LATIN_NAME %in% species & Basis == "WW" & !is.na(Klasse.2016))
# Combine muscel and liver data
sel_records <- sel_records1 | sel_records2
sum(sel_records1)  # 16
sum(sel_records2)  # 71
sum(sel_records)  # 87


df_indicator <- tibble(
  PROJECT_ID = 3699,
  LATIN_NAME = data_xl[["LATIN_NAME"]][sel_records],
  STATION_CODE = data_xl[["STATION_CODE"]][sel_records])

df_indicator <- left_join(df_indicator, df_stations, by = "STATION_CODE")
df_indicator$PARAM <- data_xl[sel_records, "PARAM"]
df_indicator$N <- NA

# View(df_indicator)
nrow(df_indicator)
# 87

```

```{r}

# Limits for EQS and Mattrygghet (food safety)
setwd("H:/Documents/seksjon 212/Indikator 2018/Analyse")
df_limits <- read_excel("../Data NIFES/Grenseverdier_fra_Sylvia.xlsx")


```



```{r}


```

